{# Phil: Templates to display time #}
{# LA-HA v2.1 #}

{# 
  from 'handy_time.jinja' import long_time, short_time, smart_time,
   delta_mins, delta_hours, delta_days, delta_duration, format_hms,
   format_hours
#}

{# Return a string expressed in days (calendar-ish rounding) #}
{# Parameters:
   - ts: Timestamp
#}
{%- macro long_time(ts) -%}
  {%- set now_ts = as_timestamp(now()) -%}
  {%- set ts_ts  = as_timestamp(ts) -%}
  {%- set delta  = ts_ts - now_ts -%}

  {%- set d = ((delta + (43200 if delta >= 0 else -43200)) / 86400) | int(0) -%}
  {%- set abs_d = d | abs -%}

  {%- if d == 0 -%}
    Today
  {%- elif d == 1 -%}
    Tomorrow
  {%- elif d == -1 -%}
    Yesterday
  {%- else -%}
    {%- set days_str = abs_d | string + " days" -%}
    {%- set weeks    = ((abs_d / 7)  + 0.5) | int(0) -%}
    {%- set months   = ((abs_d / 30) + 0.5) | int(0) -%}
    {%- set years    = ((abs_d / 365)+ 0.5) | int(0) -%}

    {%- set s = (
      days_str if abs_d < 28 else
      (weeks  | string + " weeks")  if abs_d < 120 else
      (months | string + " months") if abs_d < 1460 else
      (years  | string + " years")
    ) -%}

    {%- if d > 0 -%}
      in {{ s }}
    {%- else -%}
      {{ s }} ago
    {%- endif -%}
  {%- endif -%}
{%- endmacro -%}

{# Return a string expressed in hours/mins/secs (30s buckets) #}
{# Parameters:
   - ts: Timestamp
#}
{%- macro short_time(ts) -%}
  {%- set now_ts = as_timestamp(now()) -%}
  {%- set ts_ts  = as_timestamp(ts) -%}
  {%- set delta  = ts_ts - now_ts -%}

  {%- set abs_bucket = ((delta | abs) / 30) | int(0) * 30 -%}
  {%- if abs_bucket == 0 -%}
    now
  {%- else -%}
    {%- set days  = (abs_bucket / 86400) | int(0) -%}
    {%- set hours = ((abs_bucket % 86400) / 3600) | int(0) -%}
    {%- set mins  = (((abs_bucket % 86400) % 3600) / 60) | int(0) -%}
    {%- set secs  = (((abs_bucket % 86400) % 3600) % 60) | int(0) -%}

    {%- set s = (
      (days|string  + 'd ' if days  > 0 else '') +
      (hours|string + 'h ' if hours > 0 else '') +
      (mins|string  + 'm ' if mins  > 0 else '') +
      (secs|string  + 's ' if secs  > 0 and days < 1 else '')
    ) | trim -%}

    {%- if delta > 0 -%}
      in {{ s }}
    {%- else -%}
      {{ s }} ago
    {%- endif -%}
  {%- endif -%}
{%- endmacro -%}

{# Choose long vs short based on whole-day distance #}
{%- macro smart_time(ts) -%}
  {%- set delta = as_timestamp(ts) - as_timestamp(now()) -%}
  {%- set days = ((delta | abs) / 86400) | int(0) -%}

  {%- if days >= 14 -%}
    {{ long_time(ts) | trim }}
  {%- else -%}
    {{ short_time(ts) | trim }}
  {%- endif -%}
{%- endmacro -%}

{# Round-half-up helper
 # avoids banker's rounding and handles negatives sensibly
 #}
{%- macro round_half_up(x) -%}
  {{ (x + (0.5 if x >= 0 else -0.5)) | int(0) }}
{%- endmacro -%}

{# How many days from now to this time (future +, past -),
 # rounded to nearest day
 #}
{%- macro delta_days(ts) -%}
  {%- set x = (ts|as_timestamp - now()|as_timestamp) / 86400 -%}
  {{ round_half_up(x) }}
{%- endmacro -%}

{# How many hours from now to this time (future +, past -),
 # rounded to nearest hour
 #}
{%- macro delta_hours(ts) -%}
  {%- set x = (ts|as_timestamp - now()|as_timestamp) / 3600 -%}
  {{ round_half_up(x) }}
{%- endmacro -%}

{# How many minutes from now to this time (future +, past -), 
 # rounded to nearest minute
 #}
{%- macro delta_mins(ts) -%}
  {%- set x = (ts|as_timestamp - now()|as_timestamp) / 60 -%}
  {{ round_half_up(x) }}
{%- endmacro -%}

{# Convert h:m:s or h:m or s into "Xh Ym Zs"
   Rule: m:s must be passed as 0:m:s
#}
{%- macro format_hms(t) -%}
  {%- if t is not string -%}
    {{- t -}}
  {%- else -%}
    {%- set raw = (t | trim | regex_replace('[^0-9:]', '')) -%}
    {%- set parts = raw.split(':') -%}
    {%- set n = parts | length -%}

    {%- set h = (parts[0] | int(0)) if n >= 2 else 0 -%}
    {%- set m = (parts[1] | int(0)) if n >= 2 else 0 -%}
    {%- set s = (parts[2] | int(0)) if n == 3 else (parts[0] | int(0)) if n == 1 else 0 -%}

    {%- set total = h*3600 + m*60 + s -%}
    {%- set h = (total // 3600) | int -%}
    {%- set m = ((total % 3600) // 60) | int -%}
    {%- set s = (total % 60) | int -%}

    {%- if total == 0 -%}
      0s
    {%- else -%}
      {%- if h > 0 -%}{{- h -}}h {% endif -%}
      {%- if m > 0 -%}{{- m -}}m {% endif -%}
      {%- if s > 0 -%}{{- s -}}s{% endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endmacro -%}

{# Convert decimal hours into "Xh Ym Zs" (rounded, half-up) #}
{%- macro format_hours(decimal_hours) -%}
  {%- set x = decimal_hours * 3600 -%}
  {%- set total_seconds = (x + (0.5 if x >= 0 else -0.5)) | int(0) -%}

  {%- if total_seconds == 0 -%}
    0s
  {%- else -%}
    {%- set sign = "-" if total_seconds < 0 else "" -%}
    {%- set total_seconds = total_seconds | abs -%}
    {%- set h = (total_seconds // 3600) | int -%}
    {%- set m = ((total_seconds % 3600) // 60) | int -%}
    {%- set s = (total_seconds % 60) | int -%}

    {%- set out = (
      (h|string + "h " if h > 0 else "") +
      (m|string + "m " if m > 0 else "") +
      (s|string + "s"  if s > 0 else "")
    ) | trim -%}

    {{ sign + out }}
  {%- endif -%}
{%- endmacro -%}

{# Duration between ts1 and ts2 as "Xd Yh Zm Ws"
   Parameters:
     - ts1, ts2 : timestamps
     - show_plus: boolean (default true). If false, '+' is omitted for positive durations
     - zero_text: string to display when duration is zero (default "0s")
#}
{%- macro delta_duration(ts1, ts2, show_plus=true, zero_text="0s") -%}
  {%- set d = ts1|as_timestamp - ts2|as_timestamp -%}

  {%- if d == 0 -%}
    {{ zero_text }}
  {%- else -%}
    {%- set sign = "-" if d < 0 else ("+" if show_plus else "") -%}
    {%- set d = d | abs -%}

    {%- set days = (d // 86400) | int -%}
    {%- set h = ((d % 86400) // 3600) | int -%}
    {%- set m = ((d % 3600) // 60) | int -%}
    {%- set s = (d % 60) | int -%}

    {%- set out = (
      (days|string + "d " if days > 0 else "") +
      (h|string    + "h " if h > 0 else "") +
      (m|string    + "m " if m > 0 else "") +
      (s|string    + "s"  if s > 0 else "")
    ) | trim -%}

    {{ sign + out }}
  {%- endif -%}
{%- endmacro -%}
