{# Phil: Templates to display time in a human way #}

{# 
  from 'handy_time.jinja' import long_time, short_time, smart_time,
   delta_mins, delta_hours, delta_days, delta_duration, format_hms,
   format_hours
#}

{# Return a string expressed in days (calendar-ish rounding) #}
{# Parameters:
   - ts: Timestamp
#}
{%- macro long_time(ts) -%}
  {%- set now_ts = as_timestamp(now()) -%}
  {%- set ts_ts  = as_timestamp(ts) -%}
  {%- set delta  = ts_ts - now_ts -%}         

  {%- set d = ((delta + (43200 if delta >= 0 else -43200)) / 86400) | int(0) -%}
  {%- set abs_d = d | abs -%}

  {%- if d == 0 -%}
    Today
  {%- elif d == 1 -%}
    Tomorrow
  {%- elif d == -1 -%}
    Yesterday
  {%- else -%}
    {%- set days_str = abs_d | string + " days" -%}
    {%- set weeks    = ((abs_d / 7)  + 0.5) | int(0) -%}
    {%- set months   = ((abs_d / 30) + 0.5) | int(0) -%}
    {%- set years    = ((abs_d / 365)+ 0.5) | int(0) -%}

    {%- set s = (
      days_str if abs_d < 28 else
      (weeks  | string + " weeks")  if abs_d < 120 else
      (months | string + " months") if abs_d < 1460 else
      (years  | string + " years")
    ) -%}

    {%- if d > 0 -%}
      in {{ s }}
    {%- else -%}
      {{ s }} ago
    {%- endif -%}
  {%- endif -%}
{%- endmacro -%}

{# Return a string expressed in hours/mins/secs (30s buckets) #}
{# Parameters:
   - ts: Timestamp
#}
{%- macro short_time(ts) -%}
  {%- set now_ts = as_timestamp(now()) -%}
  {%- set ts_ts  = as_timestamp(ts) -%}
  {%- set delta  = ts_ts - now_ts -%}         

  {%- set abs_bucket = ((delta | abs) / 30) | int(0) * 30 -%}
  {%- if abs_bucket == 0 -%}
    now
  {%- else -%}
    {%- set days  = (abs_bucket / 86400) | int(0) -%}
    {%- set hours = ((abs_bucket % 86400) / 3600) | int(0) -%}
    {%- set mins  = (((abs_bucket % 86400) % 3600) / 60) | int(0) -%}
    {%- set secs  = (((abs_bucket % 86400) % 3600) % 60) | int(0) -%}

    {%- set s = (
      (days|string  + 'd ' if days  > 0 else '') +
      (hours|string + 'h ' if hours > 0 else '') +
      (mins|string  + 'm ' if mins  > 0 else '') +
      (secs|string  + 's ' if secs  > 0 and days < 1 else '')
    ) | trim -%}

    {%- if delta > 0 -%}
      in {{ s }}
    {%- else -%}
      {{ s }} ago
    {%- endif -%}
  {%- endif -%}
{%- endmacro -%}

{# Choose long vs short based on whole-day distance #}
{%- macro smart_time(ts) -%}
  {%- set delta = as_timestamp(ts) - as_timestamp(now()) -%}
  {%- set days = ((delta | abs) / 86400) | int(0) -%}

  {%- if days >= 14 -%}
    {{ long_time(ts) | trim }}
  {%- else -%}
    {{ short_time(ts) | trim }}
  {%- endif -%}
{%- endmacro -%}

{# How many days since this time #}
{# Parameters:
   - ts: Timestamp
#}
{%- macro delta_days(ts) -%}
  {%- set d = ts|as_timestamp - now()|as_timestamp -%}
  {%- set days = (d / 86400) | round(0) -%}
  {{ days }}
{%- endmacro -%}

{# How many hours since this time #}
{# Parameters:
   - ts: Timestamp
#}
{%- macro delta_hours(ts) -%}
  {%- set d = ts|as_timestamp - now()|as_timestamp -%}
  {%- set hours = (d / 3600) | round(0) -%}
  {{ hours }}
{%- endmacro -%}

{# How many minutes since this time #}
{# Parameters:
   - ts: Timestamp
#}
{%- macro delta_mins(ts) -%}
  {%- set d = ts|as_timestamp - now()|as_timestamp -%}
  {%- set mins = (d / 60) | round(0) -%}
  {{ mins }}
{%- endmacro -%}

{# Convert h:m:s into h m s string #}
{# Parameters:
   - t: Time in h:m:s format
#}
{%- macro format_hms(t) -%}
  {%- set ta = t.split(':') -%}
  {%- if ta[0]|int > 0 -%}{{- ta[0] -}}h {% endif -%}
  {%- if ta[1]|int > 0 -%}{{- ta[1] -}}m {% endif -%}
  {%- if ta[2]|int > 0 -%}{{- ta[2] -}}s {%- endif -%}
{%- endmacro -%}

{# Convert decimal hours into h m s #}
{# Parameters:
   - decminal_hours: Number of hours in decimal
#}
{%- macro format_hours(decimal_hours) -%}
  {%- set total_seconds = (decimal_hours * 3600) | round(0) -%}
  {%- if total_seconds == 0 -%}
    0s
  {%- else -%}
    {%- set sign = "-" if total_seconds < 0 else "" -%}
    {%- set total_seconds = total_seconds | abs -%}
    {%- set hours = (total_seconds // 3600) | int -%}
    {%- set minutes = ((total_seconds % 3600) // 60) | int -%}
    {%- set seconds = (total_seconds % 60) | int -%}
    {%- set time_str = (
      (hours|string + "h " if hours > 0 else "") +
      (minutes|string + "m " if minutes > 0 else "") +
      (seconds|string + "s " if seconds > 0 else "")
    ) | trim -%}
    {{ sign + time_str }}
  {%- endif -%}
{%- endmacro -%}

{# How many days between these times #}
{# Parameters:
   - ts1/ts2: Timestamps to calculate between
#}
{%- macro delta_duration(ts1, ts2) -%}
  {%- set d = ts1|as_timestamp - ts2|as_timestamp -%}
  {%- set sign = "+" if d >= 0 else "-" -%}
  {%- set d = d | abs -%}
  {%- set days = (d // 86400) | int -%}
  {%- set h = ((d % 86400) // 3600) | int -%}
  {%- set m = ((d % 3600) // 60) | int -%}
  {%- set s = (d % 60) | int -%}
  {%- set dhms = (days|string + "d " if days > 0 else "") + 
    (h|string + "h " if h > 0 else "") +
    (m|string + "m " if m > 0 else "") +
    (s|string + "s" if s > 0 else "") -%}
  {{ sign + dhms if d != 0 else '-' }}
{%- endmacro -%}
